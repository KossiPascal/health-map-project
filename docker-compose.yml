version: "3.8"

services:
  osrm-prepare:
    image: osrm/osrm-backend
    container_name: osrm-prepare
    volumes:
      - ./osrm-server:/rawdata
      - ./osrm-server/togo:/data
    working_dir: /rawdata
    command:
      - bash
      - -c
      - |
        set -e
        echo "ğŸ“¥ VÃ©rification du fichier OSM..."
        if [ ! -f /rawdata/togo-latest.osm.pbf ]; then
          echo "ğŸ“¥ TÃ©lÃ©chargement de la carte du Togo..."
          wget -O /rawdata/togo-latest.osm.pbf https://download.geofabrik.de/africa/togo-latest.osm.pbf
        else
          echo 'âœ… Fichier dÃ©jÃ  prÃ©sent.'
        fi

        echo "ğŸ“¦ğŸ—ºï¸ Extraction de la carte..."
        osrm-extract -p /opt/car.lua /rawdata/togo-latest.osm.pbf

        echo "ğŸ“ DÃ©placement des fichiers .osrm vers /data..."
        mv /rawdata/togo-latest.osrm* /data/

        echo "ğŸ§© Partition de la carte..."
        osrm-partition /data/togo-latest.osrm

        echo "ğŸ¨ Personnalisation de la carte..."
        osrm-customize /data/togo-latest.osrm

  osrm-server:
    image: osrm/osrm-backend
    container_name: osrm-server
    depends_on:
      - osrm-prepare
    volumes:
      - ./osrm-server/togo:/data
    ports:
      - "5000:5000"
    command: osrm-routed --algorithm mld /data/togo-latest.osrm
